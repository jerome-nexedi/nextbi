Jedox.studio.dialog.Security=function(dlgFlag){var that=this;this._dlgFlag=dlgFlag;var chbLOCK=false;this.permission="";this.permissionChanged=false;this.defaultPermission=false;var groupSelectedIndex;var referrersDataTypeFlag=false;var _tmpPermission;this._refreshFlag=false;this._resetFlag=false;var groupListStore=new Ext.data.SimpleStore({fields:[{name:"name",type:"string"},{name:"description",type:"string"}]});var groupListLbl=new Ext.form.Label({text:"Groups".localize().concat(":"),baseCls:"x-plain"});var space={html:"<br>",baseCls:"x-plain"};var permissionListLbl=new Ext.form.Label({text:"Permissions".localize().concat(":")});var allowLbl=new Ext.form.Label({text:"Allow".localize()});var denyLbl=new Ext.form.Label({text:"Deny".localize()});var fullControlLbl=new Ext.form.Label({text:"Full Control".localize().concat(":"),baseCls:"x-plain"});var fullControlAllowChb=new Ext.ux.form.TriCheckbox({hideLabel:true,value:false,labelStyle:"font-size:11px;",listeners:{check:function(cmp,state){if(!chbLOCK&&that.accessGroup&&!that._resetFlag){setPermission(7,false,true)}}}});var fullControlDenyChb=new Ext.ux.form.TriCheckbox({hideLabel:true,value:false,labelStyle:"font-size:11px;",listeners:{check:function(cmp,state){if(!chbLOCK&&that.accessGroup&&!that._resetFlag){setPermission(3,false,true)}}}});var writeLbl=new Ext.form.Label({text:"Write".localize().concat(":"),baseCls:"x-plain"});var writeAllowChb=new Ext.ux.form.TriCheckbox({hideLabel:true,value:false,labelStyle:"font-size:11px;",listeners:{check:function(cmp,state){if(!chbLOCK&&that.accessGroup&&!that._resetFlag){setPermission(3,false,true)}}}});var writeDenyChb=new Ext.ux.form.TriCheckbox({hideLabel:true,value:false,labelStyle:"font-size:11px;",listeners:{check:function(cmp,state){if(!chbLOCK&&that.accessGroup&&!that._resetFlag){setPermission(1,false,true)}}}});var readLbl=new Ext.form.Label({text:"Read".localize().concat(":"),baseCls:"x-plain"});var readAllowChb=new Ext.ux.form.TriCheckbox({hideLabel:true,value:false,labelStyle:"font-size:11px;",listeners:{check:function(cmp,state){if(!chbLOCK&&that.accessGroup&&!that._resetFlag){setPermission(1,false,true)}}}});var readDenyChb=new Ext.ux.form.TriCheckbox({hideLabel:true,value:false,labelStyle:"font-size:11px;",listeners:{check:function(cmp,state){if(!chbLOCK&&that.accessGroup&&!that._resetFlag){setPermission(0,false,true)}}}});var groupListView=new Ext.DataView({id:"group-list-view",store:groupListStore,tpl:new Ext.XTemplate('<div class="group-list-view"><tpl for=".">','<div class="thumb-wrap">','<div class="thumb" style="padding: 0px; text-align: left;  ">','<img class="group-icon" src="../lib/ext/resources/images/default/s.gif"/>&nbsp;{name}&nbsp;({description})</div></div>',"</tpl></div>"),multiSelect:false,singleSelect:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",emptyText:"No groups".localize(),listeners:{click:function(dataView,index,node,e){that.permissionPanel.enable();that.permissionPanel.buttons[0].enable();that.accessGroup=dataView.store.getAt(index).get("name");that.permissionChanged=false;that.defaultPermission=false;groupSelectedIndex=index;var tmpPermission;if(that._dlgFlag){switch(that._type){case"group":tmpPermission=Jedox.studio.backend.wssStudio.getPerms4UGroup(that.accessGroup,that._data.t);break;case"hierarchy":case"rhierarchy":tmpPermission=Jedox.studio.backend.wssStudio.getPerms4UGroup(that.accessGroup,that._data.t,that._data.hierarchy);break;default:tmpPermission=Jedox.studio.backend.wssStudio.getPerms4UGroup(that.accessGroup,that._data.t,that._data.hierarchy,that._data.node);break}}else{tmpPermission=Jedox.studio.backend.wssStudio.getConnPerms4UGroup(that.accessGroup,that.connectionName)}_tmpPermission=tmpPermission;var defaultFlag=tmpPermission.own<0;var permission=defaultFlag?tmpPermission.eff:tmpPermission.own;setPermission(permission,defaultFlag);setAccessGroupInterfacePermission(_tmpPermission.max)}}});var groupListPanel={layout:"fit",height:240,width:360,items:groupListView};var permissionLabelPanel={layout:"absolute",border:false,bodyStyle:"background-color: transparent;",width:360,height:15,defaults:{baseCls:"x-plain"},items:[{x:0,y:0,items:permissionListLbl},{x:280,y:0,items:allowLbl},{x:320,y:0,items:denyLbl}]};this.permissionPanel=new Ext.Panel({layout:"table",width:360,bodyStyle:"padding-left:7px",disabled:true,defaults:{baseCls:"x-plain"},layoutConfig:{columns:4},items:[{colspan:2,width:280,items:fullControlLbl},{colspan:1,width:40,items:fullControlAllowChb},{colspan:1,items:fullControlDenyChb},{colspan:2,items:writeLbl},{colspan:1,items:writeAllowChb},{colspan:1,items:writeDenyChb},{colspan:2,items:readLbl},{colspan:1,items:readAllowChb},{colspan:1,items:readDenyChb}],buttons:[{text:"Default".localize(),disabled:true,handler:onGetDefaultPermission}]});Jedox.studio.dialog.Security.superclass.constructor.call(this,{layout:"form",border:false,bodyStyle:"background-color: transparent;",items:[groupListLbl,groupListPanel,space,permissionLabelPanel,that.permissionPanel]});this.resetChbs=function(){that._resetFlag=true;fullControlAllowChb.reset();fullControlDenyChb.reset();writeAllowChb.reset();writeDenyChb.reset();readAllowChb.reset();readDenyChb.reset();that._resetFlag=false};function setPermission(p,defaultFlag,changeFlag){var permissionMap={0:"N",1:"R",3:"W",7:"D"};if(p in permissionMap){that.permission=permissionMap[p]}if(changeFlag){that.permissionChanged=true}that.defaultPermission=false;var value=defaultFlag?null:true;switch(p){case 7:setDPermission();break;case 3:setWPermission();break;case 1:setRPermission();break;case 0:setNPermission();break;default:setDPermission();break}function setDPermission(){chbLOCK=true;fullControlAllowChb.setValue(value);fullControlDenyChb.setValue(false);writeAllowChb.setValue(value);writeDenyChb.setValue(false);readAllowChb.setValue(value);readDenyChb.setValue(false);chbLOCK=false}function setWPermission(){chbLOCK=true;fullControlAllowChb.setValue(false);fullControlDenyChb.setValue(value);writeAllowChb.setValue(value);writeDenyChb.setValue(false);readAllowChb.setValue(value);readDenyChb.setValue(false);chbLOCK=false}function setRPermission(){chbLOCK=true;fullControlAllowChb.setValue(false);fullControlDenyChb.setValue(value);writeAllowChb.setValue(false);writeDenyChb.setValue(value);readAllowChb.setValue(value);readDenyChb.setValue(false);chbLOCK=false}function setNPermission(){chbLOCK=true;fullControlAllowChb.setValue(false);fullControlDenyChb.setValue(value);writeAllowChb.setValue(false);writeDenyChb.setValue(value);readAllowChb.setValue(false);readDenyChb.setValue(value);chbLOCK=false}}function setMaxPermissionInterface(maxAllowedInterfacePermission){var permType=Jedox.studio.access.permType;if(maxAllowedInterfacePermission&permType.DELETE){fullControlAllowChb.enable();fullControlDenyChb.enable();writeAllowChb.enable();writeDenyChb.enable();readAllowChb.enable();readDenyChb.enable()}else{if((maxAllowedInterfacePermission&permType.WRITE)){fullControlAllowChb.disable();fullControlDenyChb.disable();writeAllowChb.enable();writeDenyChb.enable();readAllowChb.enable();readDenyChb.enable()}else{fullControlAllowChb.disable();fullControlDenyChb.disable();writeAllowChb.disable();writeDenyChb.disable();readAllowChb.enable();readDenyChb.enable()}}}function onGetDefaultPermission(){that.permissionChanged=true;setPermission(_tmpPermission.def,true);that.permissionChanged=true;that.defaultPermission=true}function setAccessGroupInterfacePermission(maxAllowedInterfacePermission){var permType=Jedox.studio.access.permType;if(maxAllowedInterfacePermission&permType.DELETE){fullControlAllowChb.enable();fullControlDenyChb.enable();writeAllowChb.enable();writeDenyChb.enable();readAllowChb.enable();readDenyChb.enable()}else{if((maxAllowedInterfacePermission&permType.WRITE)){fullControlAllowChb.disable();fullControlDenyChb.disable();writeAllowChb.enable();writeDenyChb.enable();readAllowChb.enable();readDenyChb.enable()}else{fullControlAllowChb.disable();fullControlDenyChb.disable();writeAllowChb.disable();writeDenyChb.disable();readAllowChb.enable();readDenyChb.enable()}}}function initGroupListData(){var res=Jedox.wss.backend.conn.rpc_s("common","paloGet",["System","#_GROUP_GROUP_PROPERTIES",["#_GROUP_"],{"#_GROUP_PROPERTIES_":["description"]}]);if(res instanceof Array){Jedox.studio.app.showMessageERROR("Database error".localize(),"Can not read groups data from database".localize());return false}var data=[];for(var group in res){data.push([group,res[group].description])}groupListStore.loadData(data)}function formatTitle(value,p,record){return String.format('<div class="topic"><img src="{0}"/>&nbsp;&nbsp;{1}</div>',"res/img/fam/group.png",value)}initGroupListData()};Ext.extend(Jedox.studio.dialog.Security,Ext.Panel,{getPanel:function(){return this},reset:function(){Ext.getCmp("group-list-view").clearSelections();this.getEl().unselectable();this.resetChbs();this.permissionPanel.buttons[0].disable()},setInterfacePermission:function(perm){if(perm&Jedox.studio.access.permType.WRITE){this.enable()}else{this.disable()}},setName:function(connectionName){this.connectionName=connectionName},setData:function(type,data){this._type=type;this._data=data},getRefreshFlag:function(){return this._refreshFlag},getPermission:function(){return this.permission},savePermission:function(){if(!this.permissionPanel.disabled&&this.permissionChanged){var tmpPermission=this.defaultPermission?"":this.permission;var result;if(this._dlgFlag){switch(this._type){case"group":case"hierarchy":case"rhierarchy":result=Jedox.studio.backend.wssStudio.setNodePemission(this._data.group,"meta",this._data.node,this.accessGroup,tmpPermission,this._data.t);break;default:result=Jedox.studio.backend.wssStudio.setNodePemission(this._data.group,this._data.hierarchy,this._data.node,this.accessGroup,tmpPermission,this._data.t);break}}else{result=Jedox.studio.backend.wssStudio.setConnectionPermission(this.connectionName,this.accessGroup,tmpPermission)}if(result&&result[0]){this._refreshFlag=result[1]}this.permissionChanged=false;this.defaultPermission=false}}});