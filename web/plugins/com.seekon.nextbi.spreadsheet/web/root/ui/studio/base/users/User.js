Jedox.studio.users.User=function(addFlag){var that=this;this.addFlag=addFlag;this.userName="";var prefs_level={SERVER:0,GROUP:1,USER:2};this.availableGroupsStore=new Ext.data.SimpleStore({fields:[{name:"groupName"}]});this.userGroupsStore=new Ext.data.SimpleStore({fields:[{name:"groupName"}]});this.generalTabLbl={html:"General informations about user".localize()+"...<br><br><br>",baseCls:"x-plain",bodyStyle:"font-size:11;"};this.userNameTxf=new Ext.form.TextField({fieldLabel:"User Name".localize(),labelStyle:"font-size:11px;",cls:"preview-properties-panel",name:"userName",allowBlank:false,width:200});this.fullNameTxf=new Ext.form.TextField({fieldLabel:"Full Name".localize(),labelStyle:"font-size:11px;",cls:"preview-properties-panel",name:"fullName",width:200});this.descriptionTxa=new Ext.form.TextArea({fieldLabel:"Description".localize(),labelStyle:"font-size:11px;",cls:"preview-properties-panel",name:"description",width:200});this.splitLine={html:"<br><br>",baseCls:"split-line",width:315};this.passwordTxf=new Ext.form.TextField({fieldLabel:"Password".localize(),labelStyle:"font-size:11px;",cls:"preview-properties-panel",name:"password",width:200,baseCls:"x-plain"});this.optionsBtn=new Ext.Button({text:"Options".localize(),hidden:addFlag=="add",handler:function(){Jedox.studio.app.preferences(prefs_level.USER,that.userNameTxf.getValue())}});var optionsBtnContainer={layout:"form",baseCls:"x-plain",width:315,buttonAlign:"right",buttons:this.optionsBtn};this.accountStatusChb=new Ext.form.Checkbox({labelStyle:"font-size:11px;",hidden:true});this.memberOfTabLbl={html:"Choose the group you want to join user".localize()+"<br><br><br>",baseCls:"x-plain",bodyStyle:"font-size:11;"},this.memeberOfIS={xtype:"itemselector",name:"itemselector",fieldLabel:"ItemSelector",cls:"preview-properties-panel",hideLabel:true,fromStore:this.availableGroupsStore,dataFields:["groupName"],toStore:this.userGroupsStore,drawUpIcon:false,drawDownIcon:false,drawTopIcon:false,drawBotIcon:false,msWidth:150,msHeight:200,displayField:"groupName",imagePath:"../../../lib/ext/extensions/multiselect",toLegend:"Member Of".localize(),fromLegend:"Available Groups".localize()};this.tabPanel=new Ext.TabPanel({activeTab:0,width:400,height:400,bodyStyle:"border-left:none; border-right:none; border-top:1; border-bottom:1;",enableTabScroll:true,plain:true,defaults:{autoScroll:true,bodyStyle:"padding:10px",layout:"form"},items:[{title:"General".localize(),items:[this.generalTabLbl,this.userNameTxf,this.fullNameTxf,this.descriptionTxa,this.splitLine,this.passwordTxf,this.passwordTxf,this.splitLine,optionsBtnContainer,this.accountStatusChb,{html:"<br><br>",baseCls:"x-plain"}]},{title:"Member Of".localize(),items:[this.memberOfTabLbl,this.memeberOfIS]}]});Jedox.studio.users.User.superclass.constructor.call(this,{labelAlign:"right",border:false,bodyStyle:"padding:5px",cls:"preview-properties-panel",layout:"fit",items:[this.tabPanel],listeners:{show:function(){}},buttons:[{text:"Save".localize(),handler:this.onSave,scope:this},{text:"Cancel".localize(),handler:this.onCancel,scope:this}]});if(this.addFlag==="add"){this.initMemberOf()}};Ext.extend(Jedox.studio.users.User,Ext.Panel,{initUser:function(userName){var that=this;this.userName=userName;var db="System";var cube="#_USER_USER_PROPERTIES";var order=["#_USER_"];var props=["userName","fullName","description","password","accountStatus"];var cords={"#_USER_":[userName],"#_USER_PROPERTIES_":props};props.shift();function cb(result){if(!result){Jedox.studio.app.showMessageERROR("Database error".localize(),"Can not read data".localize());return}that.userNameTxf.setValue(that.getPropsValue(userName));that.fullNameTxf.setValue(that.getPropsValue(result[userName]["fullName"]));that.descriptionTxa.setValue(that.getPropsValue(result[userName]["description"]));that.passwordTxf.setValue(that.getPropsValue(result[userName]["password"]));that.accountStatusChb.setValue(that.getPropsValue(result[userName]["accountStatus"]));if(that.userName=="admin"&&Jedox.studio.users.internalConnection){that.passwordTxf.disable()}else{that.passwordTxf.enable()}that.initMemberOf()}Jedox.wss.backend.conn.rpc([this,cb],"common","paloGet",[db,cube,order,cords])},getPropsValue:function(value){if(value!=undefined){return value}return""},initMemberOf:function(){var that=this;var db="System";var cube="#_USER_GROUP";var order=["#_USER_"];var cords={"#_USER_":[that.userName]};function cb(result){if(!result){Jedox.studio.app.showMessageERROR("Database error".localize(),"Can not read data".localize());return}var availableGroupsData=[];var userGroupsData=[];for(user in result){for(group in result[user]){if(result[user][group]=="1"){userGroupsData.push([group])}else{availableGroupsData.push([group])}}}that.availableGroupsStore.loadData(availableGroupsData);that.userGroupsStore.loadData(userGroupsData)}Jedox.wss.backend.conn.rpc([this,cb],"common","paloGet",[db,cube,order,cords])},addUser:function(addF){var that=this;if(this.validateForm()){var db="System";var cube="#_USER_USER_PROPERTIES";var data={};var order=["#_USER_"];var add=addF;var userName=addF?this.userNameTxf.getValue():this.userName;var fullName=this.fullNameTxf.getValue();var description=this.descriptionTxa.getValue();var password=this.passwordTxf.getValue();var status=this.accountStatusChb.getValue()?"1":"0";data[userName]={fullName:fullName,description:description,password:password,accountStatus:status};function cb(result){if(!result){Jedox.studio.app.showMessageERROR("Database error".localize(),"Can not write data".localize());return}var ug_cube="#_USER_GROUP";var ug_data={};var ug_order=["#_USER_"];ug_data[userName]=that.getUserGroups();function ug_cb(result){if(!result){Jedox.studio.app.showMessageERROR("Database error".localize(),"Can not write data".localize());return}if(!addF&&userName!=that.userNameTxf.getValue()){var r_db="System";var r_dim="#_USER_";var r_data={};var newUserName=that.userNameTxf.getValue();r_data[userName]=newUserName;function r_cb(result){if(!result){Jedox.studio.app.showMessageERROR("Database error".localize(),"Can not write data".localize());return}that.onClose()}Jedox.wss.backend.conn.rpc([this,r_cb],"common","paloRename",[r_db,r_dim,r_data])}else{that.onClose()}}Jedox.wss.backend.conn.rpc([this,ug_cb],"common","paloSet",[db,ug_cube,ug_data,ug_order,add])}Jedox.wss.backend.conn.rpc([this,cb],"common","paloSet",[db,cube,data,order,add])}},getUserGroups:function(){var data={};for(var i=0,agNmbr=this.memeberOfIS.fromStore.getCount();i<agNmbr;i++){data[this.memeberOfIS.fromStore.getAt(i).get("groupName")]=""}for(var i=0,ugNmbr=this.memeberOfIS.toStore.getCount();i<ugNmbr;i++){data[this.memeberOfIS.toStore.getAt(i).get("groupName")]="1"}return data},isError:function(result){if(result[0]==="!"&&result.length===2){return true}return false},validateForm:function(){var that=this;var _return=true;function userName(){var msg="Sign in name must start with a-z/A-Z character and must contain more than two character".localize()+"...";var my_regexp=/^[a-zA-Z][a-zA-Z0-9_\-@\.]+$/;var value=that.userNameTxf.getValue();if(!my_regexp.test(value)){that.userNameTxf.markInvalid(msg);_return=false}}function fullName(){var msg="Full name must start with a-z/A-Z character".localize()+"...";var my_regexp=/^[a-zA-Z]+[\ ]*[a-zA-Z0-9\ ]*$/;var value=that.fullNameTxf.getValue();if(!my_regexp.test(value)){that.fullNameTxf.markInvalid(msg);_return=false}}function password(){var msg="Password must start with a-z/A-Z character and must contain 6 char min".localize()+"...";var my_regexp=/^[a-zA-Z]([a-zA-Z0-9#_-]{4,})$/;var value=that.passwordTxf.getValue();if(!my_regexp.test(value)){that.passwordTxf.markInvalid(msg);_return=false}}userName();fullName();password();return _return},onSave:function(){if(this.addFlag==="add"){this.addUser(true)}else{this.addUser(false)}},onCancel:function(){if(this.addFlag){this.ownerCt.ownerCt.refreshUserList();this.ownerCt.ownerCt.remove(this.ownerCt)}else{this.initUser(this.userName)}},onClose:function(){if(this.addFlag){this.ownerCt.ownerCt.refreshUserList();this.ownerCt.ownerCt.remove(this.ownerCt);if(this.addFlag=="add"){Jedox.studio.app.showTopMsg("","User added successefully".localize())}else{Jedox.studio.app.showTopMsg("","User updated successefully".localize())}}else{this.ownerCt.ownerCt.ownerCt.ownerCt.refreshUserList();Jedox.studio.app.showTopMsg("","User updated successefully".localize())}}});